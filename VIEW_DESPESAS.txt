USE financa;
GO

CREATE OR ALTER VIEW vw_AnaliseDespesas AS

-- CTE 1: Lista de Contas
WITH CONTAS_DE_INTERESSE AS (
    SELECT CONTA FROM (VALUES
        ('3.1.1.1.01.001'), ('3.1.1.1.01.002'), ('3.1.1.1.01.004'), ('3.1.1.1.01.005'), ('3.1.1.1.01.008'),
        ('3.1.1.1.02.001'), ('3.1.1.1.03.001'), ('3.1.1.1.04.001'), ('3.1.1.1.04.999'), ('3.1.1.2.01.004'),
        ('3.1.1.2.01.005'), ('3.1.1.2.01.006'), ('3.1.1.3.01.001'), ('3.1.1.3.01.002'), ('3.1.1.3.01.003'),
        ('3.1.1.3.01.004'), ('3.1.1.3.01.005'), ('3.1.1.3.01.008'), ('3.1.1.3.01.999'), ('3.1.2.1.01.001'),
        ('3.1.2.1.01.002'), ('3.1.2.1.02.001'), ('3.1.2.1.02.002'), ('3.1.2.1.02.003'), ('3.1.2.1.02.004'),
        ('3.1.2.1.02.005'), ('3.1.2.1.02.006'), ('3.1.2.1.02.007'), ('3.1.2.1.02.008'), ('3.1.2.1.02.009'),
        ('3.1.2.1.02.010'), ('3.1.2.1.02.013'), ('3.1.2.1.02.014'), ('3.1.2.1.02.019'), ('3.1.2.1.02.022'),
        ('3.1.2.1.02.999'), ('3.1.2.1.03.001'), ('3.1.2.2.01.001'), ('3.1.2.2.01.002'), ('3.1.2.2.01.003'),
        ('3.1.2.2.01.004'), ('3.1.2.2.01.005'), ('3.1.2.2.01.006'), ('3.1.2.2.01.008'), ('3.1.2.2.01.999'),
        ('3.1.2.2.02.001'), ('3.1.2.2.02.002'), ('3.1.2.2.02.004'), ('3.1.2.2.02.007'), ('3.1.2.2.02.999'),
        ('3.1.2.3.01.001'), ('3.1.3.1.01.001'), ('3.1.3.1.01.002'), ('3.1.3.1.01.003'), ('3.1.3.1.01.004'),
        ('3.1.3.1.01.005'), ('3.1.3.1.01.006'), ('3.1.3.1.01.999'), ('3.1.3.1.02.001'), ('3.1.3.1.02.002'),
        ('3.1.3.1.02.003'), ('3.1.3.1.02.004'), ('3.1.3.1.02.005'), ('3.1.3.1.02.006'), ('3.1.3.1.02.009'),
        ('3.1.3.1.02.010'), ('3.1.3.1.02.999'), ('3.1.3.2.01.001'), ('3.1.3.2.01.002'), ('3.1.3.2.01.003'),
        ('3.1.3.2.01.004'), ('3.1.3.2.01.999'), ('3.1.3.2.02.004'), ('3.1.3.3.01.001'), ('3.1.3.3.01.002'),
        ('3.1.3.3.01.003'), ('3.1.3.3.01.005'), ('3.1.3.3.01.007'), ('3.1.3.3.01.008'), ('3.1.3.3.01.999'),
        ('3.1.3.4.01.002'), ('3.1.3.4.01.003'), ('3.1.3.4.01.005'), ('3.1.3.4.01.999'), ('3.1.3.5.01.001'),
        ('3.1.3.5.01.002'), ('3.1.3.5.01.003'), ('3.1.3.5.01.004'), ('3.1.3.5.01.005'), ('3.1.3.6.01.001'),
        ('3.1.3.6.01.002'), ('3.1.3.6.01.003'), ('3.1.3.6.01.004'), ('3.1.3.6.01.005'), ('3.1.3.6.01.006'),
        ('3.1.3.6.01.999'), ('3.1.3.7.01.001'), ('3.1.3.7.01.004'), ('3.1.3.7.01.005'), ('3.1.3.7.01.006'),
        ('3.1.3.7.01.007'), ('3.1.3.7.01.008'), ('3.1.3.7.01.009'), ('3.1.3.7.01.010'), ('3.1.3.7.01.011'),
        ('3.1.3.7.01.015'), ('3.1.3.7.01.021'), ('3.1.3.7.01.023'), ('3.1.3.7.01.999'), ('3.1.3.8.01.001'),
        ('5.1.1.2.01.001'), ('5.2.2.2.01.001'), ('5.2.2.2.01.003'), ('5.2.2.2.01.004'), ('5.2.2.2.01.006'),
        ('5.2.4.1.01.001'), ('5.2.5.2.01.001')
    ) AS Contas(CONTA)
),
-- CTE 2: Centros de Custo com o mapeamento CORRETO das colunas
CENTROS_DE_CUSTO AS (
    SELECT
        NivelAcao.CODCCUSTO COLLATE Latin1_General_CI_AS AS CC,
        NivelUnidade.CAMPOLIVRE AS ACAO,
        NivelProjeto.CAMPOLIVRE AS PROJETO,
        NivelAcao.CAMPOLIVRE AS UNIDADE
    FROM HubDados.CorporeRM.GCCUSTO AS NivelAcao
    LEFT JOIN HubDados.CorporeRM.GCCUSTO AS NivelProjeto ON LEFT(NivelAcao.CODCCUSTO, 5) = NivelProjeto.CODCCUSTO
    LEFT JOIN HubDados.CorporeRM.GCCUSTO AS NivelUnidade ON LEFT(NivelAcao.CODCCUSTO, 12) = NivelUnidade.CODCCUSTO
    WHERE LEN(NivelAcao.CODCCUSTO) = 16 AND NivelAcao.ATIVO = 'T' AND NivelAcao.PERMITELANC = 'T'
),
-- CTE 3: Lançamentos de Orçamento
ORCAMENTO_UNIFICADO AS (
    -- Parte de Débito
    SELECT
        RIGHT(crt.CODGERENCIAL, 16) COLLATE Latin1_General_CI_AS AS CC, 
        cln.DEBITO COLLATE Latin1_General_CI_AS AS CONTA,
        CASE WHEN pc.Natureza = 1 THEN (crt.VLRCREDITO + CRT.VLRDEBITO) ELSE -1 * (crt.VLRCREDITO + CRT.VLRDEBITO) END AS VALOR,
        tmv.CODCFO, cln.COMPLEMENTO, cln.[DATA],cln.LCTREF
    FROM HubDados.CorporeRM.CRATEIOLC crt
    INNER JOIN HubDados.CorporeRM.CLANCA cln ON crt.LCTREF = cln.LCTREF
    LEFT JOIN HubDados.CorporeRM.TMOV tmv ON cln.INTEGRACHAVE = CAST(tmv.IDMOV AS VARCHAR(255))
    INNER JOIN HubDados.CorporeRM.CCONTA pc ON pc.CODCONTA = cln.DEBITO
    UNION ALL
    -- Parte de Crédito
    SELECT
        RIGHT(crt.CODGERENCIAL, 16) COLLATE Latin1_General_CI_AS AS CC, 
        cln.CREDITO COLLATE Latin1_General_CI_AS AS CONTA,
        CASE WHEN pc.Natureza = 0 THEN (crt.VLRCREDITO + CRT.VLRDEBITO) ELSE -1 * (crt.VLRCREDITO + CRT.VLRDEBITO) END AS VALOR,
        tmv.CODCFO, cln.COMPLEMENTO, cln.[DATA],cln.LCTREF
    FROM HubDados.CorporeRM.CRATEIOLC crt
    INNER JOIN HubDados.CorporeRM.CLANCA cln ON crt.LCTREF = cln.LCTREF
    LEFT JOIN HubDados.CorporeRM.TMOV tmv ON cln.INTEGRACHAVE = CAST(tmv.IDMOV AS VARCHAR(255))
    INNER JOIN HubDados.CorporeRM.CCONTA pc ON pc.CODCONTA = cln.CREDITO
)
-- CONSULTA FINAL
SELECT
    orc.VALOR,
    orc.COMPLEMENTO,
    orc.[DATA],
    orc.CONTA AS COD_CONTA,
    REPLACE(fcf.NOME, CHAR(22), '') AS FORNECEDOR,
	orc.LCTREF,
    cc.UNIDADE,
    cc.PROJETO,
    cc.ACAO 
FROM ORCAMENTO_UNIFICADO AS orc
INNER JOIN CONTAS_DE_INTERESSE AS f ON orc.CONTA = f.CONTA
LEFT JOIN CENTROS_DE_CUSTO AS cc ON orc.CC = cc.CC
LEFT JOIN HubDados.CorporeRM.FCFO AS fcf ON orc.CODCFO = fcf.CODCFO;
GO
