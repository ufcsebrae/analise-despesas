
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Análise de Despesas</title>
    <style>
        body { font-family: 'Calibri', 'Segoe UI', sans-serif; color: #1f497d; line-height: 1.5; }
        .container { max-width: 950px; margin: auto; padding: 20px; }
        h1, h2, h3 { color: #1f497d; border-bottom: 1px solid #c6d9f1; padding-bottom: 8px; font-weight: bold; }
        h1 { font-size: 26px; text-align: center; }
        h2 { font-size: 22px; margin-top: 40px; }
        h3 { font-size: 18px; margin-top: 25px; border-bottom: none; color: #4e81bd; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; font-size: 14px; }
        th, td { border: 1px solid #c6d9f1; padding: 10px; text-align: left; }
        th { background-color: #f2f7ff; font-weight: bold; }
        tr:nth-child(even) { background-color: #f8faff; }
        .section-intro { font-size: 15px; color: #333; background-color: #f8faff; padding: 15px; border-left: 5px solid #5b9bd5; margin-bottom: 20px; }
        .summary-table th { text-align: left; }
        .summary-table td:nth-child(2), .summary-table td:nth-child(3) { text-align: right; }
        .footer { text-align: center; color: #888; margin-top: 50px; }
        table tr:last-child { font-weight: bold; background-color: #eaf1fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Relatório de Análise de Despesas</h1>
        <p style="text-align: center;">
            <strong>Unidade:</strong> {{ unidade_gestora }} ({{ resumo.numero_unidade }}) | 
            <strong>Mês de Referência:</strong> {{ resumo.mes_referencia }} | 
            <strong>Data de Emissão:</strong> {{ data_relatorio }}
        </p>

        <div class="section-intro">
            <p><strong>Prezado(a) gestor(a),</strong></p>
            <p>Eu sou seu assistente de análise de dados. Meu trabalho é processar milhares de lançamentos financeiros e transformá-los em informações claras e acionáveis para apoiar sua gestão. Este relatório foi preparado por mim e destaca os pontos mais importantes sobre as despesas da sua unidade.</p>
            <p><strong>Conceitos e Modelos de IA Utilizados:</strong></p>
            <ul>
                <li><strong>Projetos Exclusivos vs. Compartilhados:</strong> Projetos "Exclusivos" são aqueles cujas despesas pertencem 100% à sua unidade. Projetos "Compartilhados" têm despesas que podem ser rateadas entre múltiplas unidades.</li>
                <li>
                    <strong>Ocorrências Atípicas de Contexto (Tabela 4):</strong> Esta é a principal análise de investigação. A IA agora analisa a "familiaridade" e o "desvio de valor" de cada transação. O modelo `IsolationForest` é treinado com métricas inteligentes, como a frequência do fornecedor/projeto e o Z-Score do valor, que mede quão estatisticamente incomum um valor é para seu grupo específico. Isso foca em encontrar eventos genuinamente estranhos, eliminando os ruídos.
                </li>
                <li><strong>Sinalização da IA na Tendência Mensal (Tabela 2):</strong> O robô analisa o ritmo dos seus gastos totais ao longo do ano. Se um mês tem um pico ou queda muito brusca em comparação com o padrão, ele sinaliza como "Pico Atípico" ou "Redução Atípica".</li>
                <li><strong>Análise de Comportamento (Tabela 5):</strong> A IA agrupa os tipos de despesa dos seus projetos exclusivos em "perfis" com base no seu comportamento financeiro (valor, frequência e previsibilidade), revelando a natureza dos custos da sua unidade.</li>
            </ul>
        </div>


        <h2>Resumo Executivo</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Indicador</th>
                    <th style="text-align: right;">Mês</th>
                    <th style="text-align: right;">Ano</th>
                </tr>
            </thead>
            <tbody>
                {% for item in itens_resumo %}
                <tr {% if item.is_total %}style="font-weight: bold; background-color: #eaf1fa;"{% endif %}>
                    <td>{{ item.indicador | safe }}</td>
                    <td>{{ item.mes }}</td>
                    <td>{{ item.ano }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>1. Execução Orçamentária - Ano</h2>
        <p class="section-intro">
            Comparamos o planejado (Orçado) com o gasto (Realizado). A coluna <strong>'Criticidade'</strong> age como um termômetro de risco, combinando a execução do orçamento com a ocorrência de ocorrências atípicas no ano (ver Tabela 4).<br>
            <strong>↑ Alto:</strong> Execução acima de 90%, ou acima de 75% com ocorrências atípicas.<br>
            <strong>→ Médio:</strong> Execução acima de 75%, ou qualquer projeto com ocorrências atípicas.<br>
            <strong>↓ Baixo:</strong> Projetos dentro da normalidade e com orçamento sob controle.
        </p>
        {% if tem_exclusivos %}
            <h3>1.a: Iniciativas exclusivas</h3>
            {{ tabela_orc_exclusivo | safe }}
        {% endif %}
        {% if tem_compartilhados %}
            <h3>1.b: Iniciativas compartilhadas</h3>
            {{ tabela_orc_compartilhado | safe }}
        {% endif %}

        <h2>2. Desempenho Mensal - Ano</h2>
        <p class="section-intro">
            Como nossos gastos se comportaram mês a mês? A coluna <strong>'Sinalização da IA'</strong> atua sobre o <strong>total dos gastos mensais da unidade (somando projetos exclusivos e compartilhados)</strong>. Ela utiliza um modelo de IA para identificar meses com picos ou quedas que fogem do padrão de gastos do ano. Um "Pico Atípico" ou "Redução Atípica" sinaliza desvios significativos no ritmo das despesas que merecem sua atenção.
        </p>
        {{ tabela_mes_agregado | safe }}

        <h2>3. Top 5 Fornecedores - Ano</h2>
        <p class="section-intro">Para onde o dinheiro está indo? Esta seção mostra os 5 fornecedores que mais receberam pagamentos da sua unidade.</p>
        {% if tem_fornecedores_exclusivos %}
            <h3>3.a: Fornecedores de Iniciativas exclusivas</h3>
            {{ tabela_forn_exclusivo | safe }}
        {% endif %}
        {% if tem_fornecedores_compartilhados %}
            <h3>3.b: Fornecedores de Iniciativas compartilhadas</h3>
            {{ tabela_forn_compartilhado | safe }}
        {% endif %}
        
        
        <h2>4. Ocorrências Atípicas de Contexto (Projetos Exclusivos)</h2>
        <p class="section-intro">
            <strong>Metodologia Técnica Aplicada (IA Híbrida: Z-Score + Isolation Forest):</strong><br>
            Esta é nossa análise mais avançada. Em vez de apenas olhar para nomes, a IA agora age como um auditor estatístico, avaliando cada transação em três dimensões:<br>
            <strong>1. Anomalia de Valor (Z-Score):</strong> O robô calcula a média e o desvio padrão dos gastos para <i>cada</i> combinação específica de Fornecedor-Projeto. Ele então mede quão longe (em desvios padrão) o valor do lançamento atual está da média do seu próprio grupo. Um Z-Score alto indica uma variação de valor estatisticamente significativa que foge à normalidade.<br>
            <strong>2. Familiaridade do Fornecedor:</strong> O robô mede a frequência de atividade do fornecedor na sua unidade durante o ano.<br>
            <strong>3. Familiaridade do Projeto:</strong> O robô mede a frequência de lançamentos no projeto.<br><br>
            O modelo `IsolationForest` é treinado com essas três métricas inteligentes. Ele sinaliza ocorrências onde a combinação desses fatores é rara (ex: um valor muito atípico para um fornecedor comum, ou qualquer valor para um fornecedor muito raro), focando em eventos que são genuinamente incomuns.
        </p>
        {% if tem_ocorrencias_atipicas %}
            {{ tabela_ocorrencias_atipicas | safe }}
        {% else %}
            <p>Nenhuma ocorrência atípica de contexto foi detectada nos dados do mês de referência para os projetos exclusivos desta unidade.</p>
        {% endif %}

        <h2>5. Análise de Comportamento: Contas de Projetos Exclusivos (IA) - Mês de Referência</h2>
        <p class="section-intro">
            <strong>Metodologia Técnica Aplicada (K-Means Clustering):</strong><br>
            Esta análise utiliza Inteligência Artificial para agrupar os tipos de despesa dos **projetos exclusivos da sua unidade** (usando o agrupamento contábil de Nível 4) com base em seu "DNA" financeiro. O robô identifica padrões de comportamento usando três métricas principais:<br>
            - <strong>Valor Total:</strong> O impacto financeiro total do agrupamento no ano.<br>
            - <strong>Frequência:</strong> O número de lançamentos, indicando se é um gasto recorrente ou pontual.<br>
            - <strong>Coeficiente de Variação (CV):</strong> Medida estatística que indica o nível de <strong>imprevisibilidade</strong> dos gastos mensais. Um CV alto significa que os valores variam muito de um mês para o outro.
        </p>
        {% if tem_clusters_folha %}
            {% for nome_cluster, tabela_html_cluster in clusters_folha.items() %}
                <h3>5.{{ loop.index }}: {{ nome_cluster }}</h3>
                <p class="section-intro">
                    <strong>Interpretação do Perfil:</strong> {{ resumo_clusters_folha[nome_cluster].description }}<br><br>
                    <strong>Ênfase do Perfil (Valores Médios do Grupo):</strong><br>
                    Os agrupamentos neste perfil tiveram, em média, um <strong>valor total</strong> de <strong style="color: #005691;">{{ resumo_clusters_folha[nome_cluster].valor_total }}</strong>, distribuído em aproximadamente <strong style="color: #005691;">{{ resumo_clusters_folha[nome_cluster].frequencia }}</strong> lançamentos, com um <strong>Coeficiente de Variação (imprevisibilidade)</strong> de <strong style="color: #005691;">{{ resumo_clusters_folha[nome_cluster].coef_variacao }}</strong>.
                </p>
                {{ tabela_html_cluster | safe }}
            {% endfor %}
        {% else %}
            <p>Não foi possível gerar a análise de comportamento para as contas dos projetos exclusivos desta unidade.</p>
        {% endif %}

        <p class="footer">Este é um relatório gerado automaticamente pelo Sistema de Análise de Despesas.</p>
    </div>
</body>
</html>
